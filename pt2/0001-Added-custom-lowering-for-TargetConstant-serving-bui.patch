From 23a200d641dcc77fd9d3cb6a869cb395cf822385 Mon Sep 17 00:00:00 2001
From: Seger Sars <s.j.w.sars@student.tue.nl>
Date: Sat, 28 Feb 2026 17:15:33 +0100
Subject: [PATCH] Added custom lowering for TargetConstant serving builtin
 function and the lowering of general i32 constants

---
 lib/Target/AVR/AVRISelLowering.cpp | 31 ++++++++++++++++++++++++++++--
 test/CodeGen/AVR/test-delay.ll     |  8 ++++++++
 2 files changed, 37 insertions(+), 2 deletions(-)
 create mode 100644 test/CodeGen/AVR/test-delay.ll

diff --git a/lib/Target/AVR/AVRISelLowering.cpp b/lib/Target/AVR/AVRISelLowering.cpp
index d8e8bc1f..bc5a0c95 100644
--- a/lib/Target/AVR/AVRISelLowering.cpp
+++ b/lib/Target/AVR/AVRISelLowering.cpp
@@ -174,6 +174,9 @@ AVRTargetLowering::AVRTargetLowering(AVRTargetMachine &tm)
     // improvements in how we treat 16-bit "registers" to be feasible.
   }
 
+  // Allow i32 constants as argument of intrinsics
+  setOperationAction(ISD::Constant, MVT::i32, Custom);
+
   // Division rtlib functions (not supported)
   setLibcallName(RTLIB::SDIV_I8, nullptr);
   setLibcallName(RTLIB::SDIV_I16, nullptr);
@@ -663,8 +666,6 @@ SDValue AVRTargetLowering::LowerVASTART(SDValue Op, SelectionDAG &DAG) const {
 
 SDValue AVRTargetLowering::LowerOperation(SDValue Op, SelectionDAG &DAG) const {
   switch (Op.getOpcode()) {
-  default:
-    llvm_unreachable("Don't know how to custom lower this!");
   case ISD::SHL:
   case ISD::SRA:
   case ISD::SRL:
@@ -709,6 +710,32 @@ void AVRTargetLowering::ReplaceNodeResults(SDNode *N,
     }
     break;
   }
+  case ISD::Constant: {
+	assert(N->getValueType(0) == MVT::i32 && "Expected Constant<i32>");
+	// Lower Constant<i32> into a TargetConstant iff its use is an intrinsic
+	// otherwise split into two half-parts to allow further lowering
+	bool split = true;
+	for (const auto use : N->uses()) {
+	      if (use->getOpcode() == ISD::INTRINSIC_VOID) {
+		      split = false;
+	      }
+	}
+
+	const uint32_t C = cast<ConstantSDNode>(N)->getZExtValue();
+	if (split) {
+	      // Split into Lo16, Hi16, low part first
+	      SDValue low = DAG.getConstant(C & 0xFFFF0000, DL, MVT::i16);
+	      Results.push_back(low);
+
+	      SDValue high = DAG.getConstant(C & 0x0000FFFF, DL, MVT::i16);
+	      Results.push_back(high);
+	} else {
+	      // Lower into a TargetConstant for __delay_builtin_ms
+	      SDValue newconst = DAG.getTargetConstant(C, DL, MVT::i32);
+	      Results.push_back(newconst);
+	}
+	break;
+	}
   default: {
     SDValue Res = LowerOperation(SDValue(N, 0), DAG);
 
diff --git a/test/CodeGen/AVR/test-delay.ll b/test/CodeGen/AVR/test-delay.ll
new file mode 100644
index 00000000..5260e419
--- /dev/null
+++ b/test/CodeGen/AVR/test-delay.ll
@@ -0,0 +1,8 @@
+; RUN: llc -march=avr < %s
+
+define void @test() {
+	  tail call void @llvm.avr.delay.cycles(i32 16000000)
+	    ret void
+}
+
+declare void @llvm.avr.delay.cycles(i32)
-- 
2.34.1

